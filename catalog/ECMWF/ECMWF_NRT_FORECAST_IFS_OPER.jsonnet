local id = 'ECMWF/NRT_FORECAST/IFS/OPER';
local subdir = 'ECMWF';

local ee_const = import 'earthengine_const.libsonnet';
local ee = import 'earthengine.libsonnet';
local spdx = import 'spdx.libsonnet';
local units = import 'units.libsonnet';

local license = spdx.cc_by_4_0;

local basename = std.strReplace(id, '/', '_');
local self_ee_catalog_url = ee_const.ee_catalog_url + basename;

local pressure_levels = [
  100, 1000, 150, 200, 250, 300, 400, 50, 500, 600, 700, 850, 925,
];

{
  id: id,
  title: 'ECMWF Near-Realtime IFS Atmospheric Forecasts',
  version: 'N/A',
  description: |||
    This dataset contains 15-day forecasts of the atmospheric model variables
    generated by the ECMWF Integrated Forecasting System (IFS) at 0.25 degree
    resolution. We refer to these as Near-Realtime (NRT) because new products
    are released twice a day after the release of the ECMWF realtime forecast
    data, of which this is a subset. Data may be distributed and used
    commercially with
    [proper attribution](https://apps.ecmwf.int/datasets/licences/general/).

    Products are available in Earth Engine starting with the implementation of
    [Cycle 49r1](https://confluence.ecmwf.int/display/FCST/Implementation+of+IFS+Cycle+49r1)
    on 2024/11/12; earlier products are not included. For general information
    about how to use ECMWF NRT datasets, see their
    [user documentation](https://confluence.ecmwf.int/display/DAC/ECMWF+open+data%3A+real-time+forecasts+from+IFS+and+AIFS).
    Sources files are available in the
    [Google Cloud marketplace](https://console.cloud.google.com/marketplace/product/bigquery-public-data/open-data-ecmwf).
  |||,

  'gee:categories': ['climate'],
  keywords: [
    'dewpoint',
    'ecmwf',
    'forecast',
    'global',
    'humidity',
    'precipitation',
    'pressure',
    'radiation',
    'rainfall',
    'snow',
    'soil_moisture',
    'soil_temperature',
    'temperature',
    'wind',
  ],
  providers: [
    ee.producer_provider(
       'ECMWF', 'https://www.ecmwf.int/en/forecasts/datasets/open-data'),
    ee.host_provider(self_ee_catalog_url),
  ],
  extent: ee.extent_global('2024-11-12T12:00:00Z', null),

  summaries: {
    gsd: [28000],  // 0.25 degrees
    'eo:bands': [
      {
        name: 'u_component_of_wind_100m_sfc',
        description: |||
          The horizontal speed of air moving towards the east, at a height of
          100 meters above the surface of the Earth.
        |||,
        'gee:units': units.velocity_si,
      },
      {
        name: 'v_component_of_wind_100m_sfc',
        description: |||
          The horizontal speed of air moving towards the north, at a height of
          100 meters above the surface of the Earth.
        |||,
        'gee:units': units.velocity_si,
      },
      {
        name: 'u_component_of_wind_10m_sfc',
        description: |||
          The horizontal speed of air moving towards the east, at a height of
          10 meters above the surface of the Earth.
        |||,
        'gee:units': units.velocity_si,
      },
      {
        name: 'v_component_of_wind_10m_sfc',
        description: |||
          The horizontal speed of air moving towards the north, at a height of
          10 meters above the surface of the Earth.
        |||,
        'gee:units': units.velocity_si,
      },
      {
        name: 'dewpoint_temperature_2m_sfc',
        description: |||
          The temperature to which the air, at 2 meters above the surface of
          the Earth, would have to be cooled for saturation to occur.
        |||,
        'gee:units': units.celsius,
      },
      {
        name: 'temperature_2m_sfc',
        description: |||
          The temperature of air at 2m above the surface of land, sea or in-land
          waters.
        |||,
        'gee:units': units.celsius,
      },
      {
        name: 'snow_albedo_sfc',
        description: |||
          The fraction of solar (shortwave) radiation reflected by snow across
          the solar spectrum.
        |||,
        'gee:units': units.dimensionless,
      },
      {
        name: 'eastward_turbulent_surface_stress_sfc',
        description: |||
          The accumulated stress on the Earth's surface in the eastward
          direction due to both the turbulent interactions between the
          atmosphere and the surface, and to turbulent orographic form drag.
        |||,
        'gee:units': units.pascal_seconds,
      },
    ] + [
      {
        name: 'divergence_pl' + pl,
        description: |||
          The rate at which air is spreading out horizontally from a point, per
          square meter, measured at a pressure level of
        ||| + pl + |||
          &nbsp;hPa. This parameter is positive for air that is spreading out,
          or diverging, and negative for the opposite, for air that is
          concentrating, or converging.
        |||,
        'gee:units': units.pascal_seconds,
      } for pl in pressure_levels
    ] + [
      {
        name: 'geopotential_height_pl' + pl,
        description: |||
          A measure of the height of a point in the atmosphere in relation to
          its potential energy, at a pressure level of
        ||| + pl + |||
          &nbsp;hPa. It is calculated by dividing the geopotential by the
          Earth's mean gravitational acceleration, g.
        |||,
        'gee:units': units.geopotential_meter,
      } for pl in pressure_levels
    ] + [
      {
        name: 'land_sea_mask_sfc',
        description: |||
          The proportion of land, as opposed to ocean or inland waters (lakes,
          reservoirs, rivers and coastal waters).
        |||,
        'gee:units': units.dimensionless,
      },
      {
        name: 'mean_sea_level_pressure_sfc',
        description: |||
          A measure of the weight that all the air in a column vertically above
          the area of Earth's surface would have at that point, if the point
          were located at the mean sea level, calculated over all surfaces.
        |||,
        'gee:units': units.pascal,
      },
      {
        name: 'most_unstable_convective_available_potential_energy_sfc',
        description: |||
          The parcel with the most Convective Available Potential Energy (CAPE,
          the amount of energy available for convection) found in the atmosphere
          from the surface up to 350 hPa.
        |||,
        'gee:units': units.joules_per_kg,
      },
      {
        name: 'northward_turbulent_surface_stress_sfc',
        description: |||
          The accumulated stress on the Earth's surface in the northward
          direction due to both the turbulent interactions between the
          atmosphere and the surface, and to turbulent orographic form drag.
        |||,
        'gee:units': units.pascal_seconds,
      },
      {
        name: 'precipitation_type_sfc',
        description: |||
          The type of precipitation at the surface:

          * 0 = No precipitation
          * 1 = Rain
          * 3 = Freezing rain (i.e. supercooled raindrops which freeze on
          contact with the ground and other surfaces)
          * 5 = Snow
          * 6 = Wet snow (i.e. snow particles which are starting to melt)
          * 7 = Mixture of rain and snow
          * 8 = Ice pellets
          * 12 = Freezing drizzle (i.e. supercooled drizzle which freezes on
          contact with the ground and other surfaces)
        |||,
      },
    ] + [
      {
        name: 'specific_humidity_pl' + pl,
        description: |||
          The mass of water vapour per kilogram of moist air (the sum of the dry
          air, water vapour, cloud liquid, cloud ice, rain and falling snow) at
          a pressure level of
        ||| + pl + ' hPa.',
        'gee:units': units.mass_fraction,
      } for pl in pressure_levels
    ] + [
      {
        name: 'relative_humidity_pl' + pl,
        description: |||
          The water vapour pressure as a percentage of the value at which the
          air becomes saturated (the point at which water vapour begins to
          condense into liquid water or deposition into ice) at a pressure level
          of
        ||| + pl + ' hPa.',
        'gee:units': units.percent,
      } for pl in pressure_levels
    ] + [
      {
        name: 'runoff_sfc',
        description: |||
          A cumulative measurement (since forecast hour 0) of the amount of
          water not absorbed by the soil from rainfall, snow melt, etc. It is
          the depth the water would have if it were spread evenly over the grid
          box.
        |||,
        'gee:units': units.meter,
      },
      {
        name: 'sea_ice_thickness_sfc',
        description: 'Sea ice thickness.',
        'gee:units': units.meter,
      },
      {
        name: 'skin_temperature_sfc',
        description: |||
          The temperature of the surface of the Earth. It represents the
          temperature of the uppermost surface layer, which has no heat capacity
          and so can respond instantaneously to changes in surface fluxes.
        |||,
        'gee:units': units.celsius,
      },
      {
        name: 'soil_temperature_sol1',
        description: |||
          The temperature of the soil at the middle of layer 1, 0-7 cm below
          the surface.
        |||,
        'gee:units': units.kelvin,
      },
      {
        name: 'soil_temperature_sol2',
        description: |||
          The temperature of the soil at the middle of layer 2, 7-28 cm below
          the surface.
        |||,
        'gee:units': units.kelvin,
      },
      {
        name: 'soil_temperature_sol3',
        description: |||
          The temperature of the soil at the middle of layer 3, 28-100 cm below
          the surface.
        |||,
        'gee:units': units.kelvin,
      },
      {
        name: 'soil_temperature_sol4',
        description: |||
          The temperature of the soil at the middle of layer 4, 100-289 cm below
          the surface.
        |||,
        'gee:units': units.kelvin,
      },
      {
        name: 'surface_pressure_sfc',
        description: |||
          The pressure (force per unit area) of the atmosphere on the surface of
          land, sea and in-land water. It is a measure of the weight of all the
          air in a column vertically above the area of the Earth's surface
          represented at a fixed point.
        |||,
        'gee:units': units.pascal,
      },
      {
        name: 'surface_net_solar_radiation_sfc',
        description: |||
          A cumulative measurement (since forecast hour 0) of the amount of
          solar radiation that reaches a horizontal plane at the surface of the
          Earth (both direct and diffuse) minus the amount reflected by the
          Earth's surface.
        |||,
        'gee:units': units.joules_per_meter2,
      },
      {
        name: 'surface_solar_radiation_downwards_sfc',
        description: |||
          A cumulative measurement (since forecast hour 0) of the amount of
          solar radiation that reaches a horizontal plane at the surface of the
          Earth (both direct and diffuse).
        |||,
        'gee:units': units.joules_per_meter2,
      },
      {
        name: 'surface_net_thermal_radiation_sfc',
        description: |||
          A cumulative measurement (since forecast hour 0) of the difference
          between the download and upward thermal radiation at the surface of
          the Earth, where thermal radiation refers to radiation emitted by the
          atmosphere, clouds and the surface.
        |||,
        'gee:units': units.joules_per_meter2,
      },
      {
        name: 'surface_thermal_radiation_downwards_sfc',
        description: |||
          A cumulative measurement (since forecast hour 0) of the amount of
          thermal radiation emitted by the atmosphere and clouds that reaches a
          horizontal plane at the surface of the Earth.
        |||,
        'gee:units': units.joules_per_meter2,
      },
      {
        name: 'eastward_surface_sea_water_velocity_sfc',
        description: 'The velocity of sea water moving east.',
        'gee:units': units.velocity_si,
      },
      {
        name: 'northward_surface_sea_water_velocity_sfc',
        description: 'The velocity of sea water moving north.',
       'gee:units': units.velocity_si,
      },
    ] + [
      {
        name: 'temperature_pl' + pl,
        description: |||
          The temperature of the atmoshere at a pressure level of
        ||| + pl + ' hPa.',
        'gee:units': units.celsius,
      } for pl in pressure_levels
    ] + [
      {
        name: 'total_column_water_sfc',
        description: |||
          The sum of water vapour, liquid water, cloud ice, rain and snow in a
          column extending from the surface of the Earth to the top of the
          atmosphere.
        |||,
        'gee:units': units.area_density,
      },
      {
        name: 'total_column_water_vapour_sfc',
        description: |||
          The total amount of water vapour in a column extending from the
          surface of the Earth to the top of the atmosphere.
        |||,
        'gee:units': units.area_density,
      },
      {
        name: 'total_precipitation_sfc',
        description: |||
          Cumulative measurement (since forecast hour 0) of the amount of liquid
          and frozen water, comprising rain and snow, that falls to the Earth's
          surface. It is the depth the water would have if it were spread evenly
          over the grid box.
        |||,
        'gee:units': units.meter,
      },
      {
        name: 'total_precipitation_rate_sfc',
        description: |||
          The mean rate of total precipitation as the water equivalent in
          meters (the depth it would have if it were spread evenly over the
          grid box) which falls per second.
        |||,
        // Not really velocity, but m/s as a rate.
        'gee:units': units.velocity_si,
      },
      {
        name: 'top_net_thermal_radiation_sfc',
        description: |||
          Cumulative measurement (since forecast hour 0) of negative Outgoing
          Longwave Radiation (OLR), the thermal radiation emitted to space at
          the top of the atmosphere.
        |||,
        'gee:units': units.joules_per_meter2,
      },
    ] + [
      {
        name: 'u_component_of_wind_pl' + pl,
        description: |||
          The horizontal speed of air moving towards the east at a pressure
          level of
        ||| + pl + ' hPa.',
        'gee:units': units.velocity_si,
      } for pl in pressure_levels
    ] + [
      {
        name: 'v_component_of_wind_pl' + pl,
        description: |||
          The horizontal speed of air moving towards the north at a pressure
          level of
        ||| + pl + ' hPa.',
        'gee:units': units.velocity_si,
      } for pl in pressure_levels
    ] + [
      {
        name: 'vorticity_pl' + pl,
        description: |||
          The rotation of air in the horizontal, around a vertical axis,
          relative to a fixed point on the surface of the Earth at a pressure
          level of
        ||| + pl + ' hPa.',
        'gee:units': units.inverse_second,
      } for pl in pressure_levels
    ] + [
      {
        name: 'volumetric_soil_moisture_sol1',
        description: |||
          The volume of water in soil layer 1, 0-7 cm below the surface.
        |||,
        'gee:units': units.volume_fraction,
      },
      {
        name: 'volumetric_soil_moisture_sol2',
        description: |||
          The volume of water in soil layer 2, 7-28 cm below the surface.
        |||,
        'gee:units': units.volume_fraction,
      },
      {
        name: 'volumetric_soil_moisture_sol3',
        description: |||
          The volume of water in soil layer 3, 28-100 cm below the surface.
        |||,
        'gee:units': units.volume_fraction,
      },
      {
        name: 'volumetric_soil_moisture_sol4',
        description: |||
          The volume of water in soil layer 4, 100-289 cm below the surface.
        |||,
        'gee:units': units.volume_fraction,
      },
    ] + [
      {
        name: 'vertical_velocity_pl' + pl,
        description: |||
          The speed of air motion in the upward or downward direction, at a
          pressure level of
        ||| + pl + ' hPa.',
        'gee:units': units.pascal_seconds,
      } for pl in pressure_levels
    ] + [
      {
        name: 'sea_surface_height_sfc',
        description: 'Sea surface height.',
        'gee:units': units.meter,
      },
      {
        name: 'max_10m_wind_gust_since_last_post_processing_sfc',
        description: |||
          Maximum 3 second wind at 10 m height as defined by World
          Meteorological Organization. Available at forecast hours 0-90 and
          150-360.
        |||,
        'gee:units': units.velocity_si,
      },
      {
        name: 'max_10m_wind_gust_last_3h_sfc',
        description: |||
          The maximum wind gust in the last 3 hours at a height of ten meters
          above the surface of the Earth. Available at forecast hours 93-144.
        |||,
        'gee:units': units.velocity_si,
      },
      {
        name: 'min_2m_temperature_last_3h_sfc',
        description: |||
          The lowest value of 2 meter temperature in the previous 3 hour period.
          Available at forecast hours 0-144.
        |||,
        'gee:units': units.celsius,
      },
      {
        name: 'min_2m_temperature_last_6h_sfc',
        description: |||
          The lowest value of 2 meter temperature in the previous 6 hour period.
          Available at forecast hours 150-360.
        |||,
        'gee:units': units.celsius,
      },
      {
        name: 'max_2m_temperature_last_3h_sfc',
        description: |||
          The highest value of 2 meter temperature in the previous 3 hour
          period. Available at forecast hours 0-144.
        |||,
        'gee:units': units.celsius,
      },
      {
        name: 'max_2m_temperature_last_6h_sfc',
        description: |||
          The highest value of 2 meter temperature in the previous 6 hour
          period. Available at forecast hours 150-360.
        |||,
        'gee:units': units.celsius,
      },
    ],

    // TODO(dpencosk): Add band statistics.
    // If the exact statistics are unknown, then set gee:estimated_range=true.
    // band_name_1: {minimum: 0, maximum: 255, 'gee:estimated_range': false},

    'gee:visualizations': [
      {
        display_name: 'Temperature 2m above the surface (Celsius)',
        lookat: {lon: 125, lat: 31, zoom: 4},
        image_visualization: {
          band_vis: {
            min: [-20],
            max: [40],
            palette: ['purple', 'blue', 'green', 'yellow', 'orange', 'red'],
            bands: ['temperature_2m_sfc'],
          },
        },
      },
    ],

    'gee:schema': [
      {
        name: 'creation_day',
        description: 'Day of the month when the forecast was created.',
        type: ee_const.var_type.int,
      },
      {
        name: 'creation_doy',
        description: 'Day of the year when the forecast was created.',
        type: ee_const.var_type.int,
      },
      {
        name: 'creation_hour',
        description: 'Hour of the day when the forecast was created.',
        type: ee_const.var_type.int,
      },
      {
        name: 'creation_month',
        description: 'Month of the year when the forecast was created.',
        type: ee_const.var_type.int,
      },
      {
        name: 'creation_time',
        description: |||
          Time, in unix epoch milliseconds, when forecast was created.
        |||,
        type: ee_const.var_type.int,
      },
      {
        name: 'creation_year',
        description: 'Year when the forecast was created.',
        type: ee_const.var_type.int,
      },
      {
        name: 'forecast_hours',
        description: |||
          Hours into the future, relative to `creation_time`, of the forecast.
        |||,
        type: ee_const.var_type.int,
      },
      {
        name: 'forecast_time',
        description: 'Time, in unix epoch milliseconds, of the forecast.',
        type: ee_const.var_type.int,
      },
      {
        name: 'model',
        description: |||
          The ECMWF forecasting model:

          * ifs: Integrated Forecasting System
          * aifs: Artificial Intelligence/Integrated Forecasting System
        |||,
        type: ee_const.var_type.string,
      },
      {
        name: 'stream',
        description: |||
          The stream from which the variables were fetched. See the full list
          [here](https://codes.ecmwf.int/grib/format/mars/stream/).
        |||,
        type: ee_const.var_type.string,
      },
    ],
  },

  'gee:interval': {
    type: 'cadence',
    unit: 'hour',
    interval: 12,
  },

  'sci:doi': '10.21957/open-data',
  'gee:terms_of_use': ee.gee_terms_of_use(license),
  // TODO(dpencosk): Remove gee:status when the dataset is ready.
  'gee:status': 'incomplete',
  'gee:type': ee_const.gee_type.image_collection,
  license: license.id,
  links: ee.standardLinks(subdir, id),
  type: ee_const.stac_type.collection,
  stac_version: ee_const.stac_version,
  stac_extensions: [
    ee_const.ext_eo,
    ee_const.ext_sci,
    ee_const.ext_ver,
  ],
}
